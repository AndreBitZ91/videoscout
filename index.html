<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AT Analyzer Pro | Scouting</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Fontes -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;700&display=swap');

        :root {
            --slate-950: #020617;
            --slate-900: #0f172a;
        }

        body {
            background-color: var(--slate-950);
            color: #f1f5f9;
            font-family: 'Inter', sans-serif;
            overflow: hidden;
        }

        .font-mono { font-family: 'JetBrains Mono', monospace; }

        /* Scrollbar Personalizada */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #475569; }

        .glass {
            background: rgba(15, 23, 42, 0.8);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .court-gradient {
            background: radial-gradient(circle at center, #1e293b 0%, #0f172a 100%);
        }

        /* Anima√ß√£o para quando se inicia um corte (como estava no teu index-2.html) */
        @keyframes pulse-red {
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }
        .recording-pulse { animation: pulse-red 2s infinite; }

        /* Sliders de V√≠deo */
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 16px;
            width: 16px;
            border-radius: 50%;
            background: #3b82f6;
            cursor: pointer;
            box-shadow: 0 0 10px rgba(59, 130, 246, 0.5);
            margin-top: -6px;
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px;
            cursor: pointer;
            background: #1e293b;
            border-radius: 2px;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="module">
        import React, { useState, useRef, useEffect, useCallback, useMemo } from 'https://esm.sh/react@18.2.0';
        import ReactDOM from 'https://esm.sh/react-dom@18.2.0/client';
        import { 
            Play, Pause, Scissors, Download, Upload, Trash2, Tag, ChevronRight, Save, X, RotateCcw, 
            FolderInput, Plus, MinusCircle, FileSpreadsheet, CheckSquare, Square, Film, Loader2, 
            Clapperboard, MonitorPlay, Settings, UserPlus, Users, Shirt, Shield, Swords, FileJson, 
            SaveAll, Database, MapPin, BarChart2, Filter, PieChart, LayoutGrid, RefreshCw, FileVideo, 
            Terminal, Copy, PlaySquare, HelpCircle, TrendingUp, Target, Activity, AlertTriangle, Hand, 
            ListVideo, Command, Trophy, Clock, Flag, Timer, Edit, Pencil, ArrowUpRight, ArrowDownRight, 
            UserMinus, User, Image as ImageIcon, FileText, Calendar, Home, ArrowLeft, Globe, Search, 
            LayoutList, CheckCircle2, ChevronLeft, GraduationCap, Medal, Share2, MoreVertical
        } from 'https://esm.sh/lucide-react@0.263.1';

        // =========================================================================
        // üì¶ M√ìDULO 1: CONSTANTES E UTILIT√ÅRIOS
        // =========================================================================
        const formatTime = (seconds) => {
            if (seconds === undefined || seconds === null || isNaN(seconds)) return "00:00.0";
            const m = Math.floor(seconds / 60);
            const s = Math.floor(seconds % 60);
            const ms = Math.floor((seconds % 1) * 10);
            return `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}.${ms}`;
        };

        const getHeatmapColor = (efficiency) => {
            if (efficiency === null || efficiency === undefined) return "#1e293b"; 
            if (efficiency < 0.3) return "rgba(239, 68, 68, 0.8)";
            if (efficiency < 0.5) return "rgba(249, 115, 22, 0.8)";
            if (efficiency < 0.7) return "rgba(234, 179, 8, 0.8)";
            return "rgba(34, 197, 94, 0.8)";
        };

        const staticCategories = {
            "Resultado": ["Golo", "Defesa", "Fora", "Poste", "7 Metros"],
            "Turn Over": ["Falha T√©cnica", "Intercep√ß√£o"],
            "Fase": ["Ofensiva", "Defensiva", "Contra-Ataque", "Retorno"]
        };
        const zones = ["Zona 1", "Zona 2", "Zona 3", "Zona 4", "Zona 5", "Zona 6", "Zona 7", "Zona 8"];

        // =========================================================================
        // üß© M√ìDULO 2: COMPONENTES UI REUTILIZ√ÅVEIS
        // =========================================================================
        const Button = ({ children, onClick, variant = "primary", size = "md", className = "", icon: Icon }) => {
            const variants = {
                primary: "bg-blue-600 hover:bg-blue-500 text-white shadow-lg shadow-blue-900/20 border border-blue-500",
                secondary: "bg-slate-800 hover:bg-slate-700 text-slate-200 border border-slate-700",
                danger: "bg-red-600 hover:bg-red-500 text-white shadow-lg shadow-red-900/20 border border-red-500",
                ghost: "hover:bg-slate-800 text-slate-400 hover:text-white",
                success: "bg-emerald-600 hover:bg-emerald-500 text-white shadow-lg shadow-emerald-900/20 border border-emerald-500"
            };
            const sizes = { sm: "px-3 py-1.5 text-xs", md: "px-4 py-2 text-sm", lg: "px-6 py-3 text-base" };
            return React.createElement('button', {
                type: 'button', // Corre√ß√£o Cr√≠tica: Impede submiss√µes fantasmas
                onClick: (e) => { e.preventDefault(); if(onClick) onClick(e); },
                className: `flex items-center justify-center gap-2 rounded-lg font-bold transition-all active:scale-95 ${variants[variant]} ${sizes[size]} ${className}`
            }, Icon && React.createElement(Icon, { size: size === 'sm' ? 14 : 18 }), children);
        };

        const TagButton = ({ label, selected, onClick, color = "blue" }) => {
            const colors = {
                blue: selected ? "bg-blue-600 text-white border-blue-500 shadow-lg shadow-blue-900/50" : "bg-slate-900 text-slate-400 border-slate-700 hover:border-blue-500/50 hover:text-blue-300",
                green: selected ? "bg-emerald-600 text-white border-emerald-500 shadow-lg shadow-emerald-900/50" : "bg-slate-900 text-slate-400 border-slate-700 hover:border-emerald-500/50 hover:text-emerald-300",
                yellow: selected ? "bg-amber-500 text-slate-900 border-amber-400 shadow-lg shadow-amber-900/50" : "bg-slate-900 text-slate-400 border-slate-700 hover:border-amber-500/50 hover:text-amber-300",
                red: selected ? "bg-red-600 text-white border-red-500 shadow-lg shadow-red-900/50" : "bg-slate-900 text-slate-400 border-slate-700 hover:border-red-500/50 hover:text-red-300"
            };
            return React.createElement('button', {
                type: 'button',
                onClick: (e) => { e.preventDefault(); onClick(e); },
                className: `px-3 py-1.5 rounded-lg text-xs font-bold border transition-all active:scale-95 ${colors[color]}`
            }, label);
        };

        const Card = ({ children, title, icon: Icon, className = "", extra }) => (
            React.createElement('div', { className: `bg-slate-900 border border-slate-800 rounded-xl overflow-hidden shadow-xl ${className}` },
                title && React.createElement('div', { className: "px-5 py-4 border-b border-slate-800 flex justify-between items-center bg-slate-900/50" },
                    React.createElement('h3', { className: "font-bold text-slate-200 flex items-center gap-2" }, Icon && React.createElement(Icon, { size: 18, className: "text-blue-500" }), title),
                    extra
                ),
                React.createElement('div', { className: "p-5" }, children)
            )
        );

        const Modal = ({ isOpen, onClose, title, children, maxWidth = "max-w-2xl" }) => {
            if (!isOpen) return null;
            return ReactDOM.createPortal(
                React.createElement('div', { className: "fixed inset-0 z-[100] flex items-center justify-center p-4 bg-black/80 backdrop-blur-sm animate-in fade-in" },
                    React.createElement('div', { className: `bg-slate-950 w-full ${maxWidth} rounded-2xl border border-slate-800 shadow-2xl overflow-hidden flex flex-col max-h-[90vh]` },
                        React.createElement('div', { className: "px-6 py-4 border-b border-slate-800 flex justify-between items-center bg-slate-900" },
                            React.createElement('h2', { className: "text-lg font-bold text-white" }, title),
                            React.createElement('button', { type: "button", onClick: onClose, className: "p-2 hover:bg-slate-800 rounded-full transition-colors text-slate-400 hover:text-white" }, React.createElement(X, { size: 20 }))
                        ),
                        React.createElement('div', { className: "flex-1 overflow-y-auto" }, children)
                    )
                ),
                document.body
            );
        };

        // =========================================================================
        // üé£ M√ìDULO 3: BASE DE DADOS GLOBAL (O CORA√á√ÉO DA APLICA√á√ÉO - SEGURO)
        // Usa prevState de forma r√≠gida para evitar Stale State Closures!
        // =========================================================================
        const useGlobalDatabase = () => {
            const [data, setData] = useState(() => {
                try {
                    const local = localStorage.getItem('ata_db_v4');
                    if (local && local !== "null") return JSON.parse(local);
                } catch (e) { console.error("Erro ao ler DB", e); }
                return { teams: [], comps: [], games: [] };
            });

            useEffect(() => {
                try {
                    localStorage.setItem('ata_db_v4', JSON.stringify(data));
                } catch (e) { console.error("Erro ao guardar DB", e); }
            }, [data]);

            // Fun√ß√µes blindadas que usam sempre o estado mais recente (prev)
            const db = {
                data: {
                    teams: data.teams || [],
                    comps: data.comps || [],
                    games: data.games || []
                },
                addTeam: (team) => setData(prev => ({ ...prev, teams: [...(prev.teams || []), team] })),
                addComp: (comp) => setData(prev => ({ ...prev, comps: [...(prev.comps || []), comp] })),
                addGame: (game) => setData(prev => ({ ...prev, games: [...(prev.games || []), game] })),
                deleteTeam: (id) => setData(prev => ({ ...prev, teams: (prev.teams || []).filter(t => t.id !== id) })),
                deleteComp: (id) => setData(prev => ({ ...prev, comps: (prev.comps || []).filter(c => c.id !== id) })),
                deleteGame: (id) => setData(prev => ({ ...prev, games: (prev.games || []).filter(g => g.id !== id) })),
                updateTeam: (updatedTeam) => setData(prev => ({ ...prev, teams: (prev.teams || []).map(t => t.id === updatedTeam.id ? updatedTeam : t) })),
                updateGame: (updatedGame) => setData(prev => ({ ...prev, games: (prev.games || []).map(g => g.id === updatedGame.id ? updatedGame : g) })),
                importDB: (importedData) => setData(importedData)
            };

            return db;
        };

        // =========================================================================
        // üè† M√ìDULO 4: DASHBOARD VIEW & SUB-MANAGERS
        // =========================================================================
        
        // 4.1. GESTOR DE EQUIPAS
        const TeamsManager = ({ db }) => {
            const [isNewTeamOpen, setIsNewTeamOpen] = useState(false);
            const [editingTeam, setEditingTeam] = useState(null);
            const [newTeam, setNewTeam] = useState({ name: '', logo: '', players: [] });
            const [newPlayer, setNewPlayer] = useState({ number: '', name: '' });

            const handleAddTeam = () => {
                if (!newTeam.name) return;
                db.addTeam({ id: Date.now().toString(), ...newTeam });
                setNewTeam({ name: '', logo: '', players: [] });
                setIsNewTeamOpen(false);
            };

            const handleAddPlayer = () => {
                if (!newPlayer.number || !newPlayer.name || !editingTeam) return;
                const updatedPlayers = [...(editingTeam.players || []), { id: Date.now().toString(), ...newPlayer }];
                const updatedTeam = { ...editingTeam, players: updatedPlayers };
                db.updateTeam(updatedTeam);
                setEditingTeam(updatedTeam); // Atualiza modal local
                setNewPlayer({ number: '', name: '' });
            };

            const handleDeletePlayer = (playerId) => {
                const updatedPlayers = (editingTeam.players || []).filter(p => p.id !== playerId);
                const updatedTeam = { ...editingTeam, players: updatedPlayers };
                db.updateTeam(updatedTeam);
                setEditingTeam(updatedTeam); // Atualiza modal local
            };

            return React.createElement('div', { className: "space-y-6 animate-in fade-in" },
                React.createElement('div', { className: "flex justify-end" }, 
                    React.createElement(Button, { icon: Plus, onClick: () => setIsNewTeamOpen(true) }, "Adicionar Equipa")
                ),
                React.createElement('div', { className: "grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4" },
                    db.data.teams.map(team => React.createElement(Card, { key: team.id, title: team.name, icon: Shield },
                        React.createElement('div', { className: "text-center py-4" },
                            React.createElement('div', { className: "w-16 h-16 bg-slate-800 rounded-2xl mx-auto mb-4 flex items-center justify-center border border-slate-700 overflow-hidden" },
                                team.logo ? React.createElement('img', { src: team.logo, className: "w-full p-2 h-full object-contain" }) : React.createElement(Shield, { size: 32, className: "text-slate-600" })
                            ),
                            React.createElement('p', { className: "text-xs font-bold text-slate-400 bg-slate-800 inline-block px-3 py-1 rounded-full border border-slate-700" }, `${(team.players || []).length} Atletas`),
                            React.createElement('div', { className: "mt-6 flex gap-2 justify-center" },
                                React.createElement(Button, { size: "sm", variant: "secondary", icon: Users, onClick: () => setEditingTeam(team) }, "Plantel"),
                                React.createElement(Button, { size: "sm", variant: "ghost", icon: Trash2, onClick: () => { if(confirm(`Apagar equipa ${team.name}?`)) db.deleteTeam(team.id) } })
                            )
                        )
                    ))
                ),
                // Modal Criar Equipa
                React.createElement(Modal, { isOpen: isNewTeamOpen, onClose: () => setIsNewTeamOpen(false), title: "Nova Equipa" },
                    React.createElement('div', { className: "p-6 space-y-4" },
                        React.createElement('input', { placeholder: "Nome da Equipa", className: "w-full bg-slate-900 border border-slate-700 p-3 rounded-lg text-slate-200 outline-none focus:border-blue-500", value: newTeam.name, onChange: e => setNewTeam({...newTeam, name: e.target.value}) }),
                        React.createElement('input', { placeholder: "URL do Logo (Opcional)", className: "w-full bg-slate-900 border border-slate-700 p-3 rounded-lg text-slate-200 outline-none focus:border-blue-500", value: newTeam.logo, onChange: e => setNewTeam({...newTeam, logo: e.target.value}) }),
                        React.createElement(Button, { className: "w-full", onClick: handleAddTeam, variant: "success" }, "Guardar Equipa")
                    )
                ),
                // Modal Plantel
                React.createElement(Modal, { isOpen: !!editingTeam, onClose: () => setEditingTeam(null), title: `Plantel: ${editingTeam?.name}` },
                    React.createElement('div', { className: "p-6 flex flex-col h-[60vh]" },
                        React.createElement('div', { className: "flex gap-2 mb-6 bg-slate-900 p-4 rounded-xl border border-slate-800" },
                            React.createElement('input', { placeholder: "N¬∫", type: "number", className: "w-20 bg-slate-950 border border-slate-700 p-3 rounded-lg text-slate-200 outline-none focus:border-blue-500 font-mono text-center", value: newPlayer.number, onChange: e => setNewPlayer({...newPlayer, number: e.target.value}) }),
                            React.createElement('input', { placeholder: "Nome do Atleta", className: "flex-1 bg-slate-950 border border-slate-700 p-3 rounded-lg text-slate-200 outline-none focus:border-blue-500", value: newPlayer.name, onChange: e => setNewPlayer({...newPlayer, name: e.target.value}) }),
                            React.createElement(Button, { onClick: handleAddPlayer, variant: "primary", icon: Plus }, "Adicionar")
                        ),
                        React.createElement('div', { className: "flex-1 overflow-y-auto space-y-2 pr-2" },
                            (editingTeam?.players || []).length === 0 ? React.createElement('p', { className: "text-center text-slate-500 py-10" }, "Nenhum jogador registado na equipa.") :
                            (editingTeam?.players || []).map(p => React.createElement('div', { key: p.id, className: "flex justify-between items-center bg-slate-800 p-3 rounded-lg border border-slate-700" },
                                React.createElement('div', { className: "flex items-center gap-4" },
                                    React.createElement('span', { className: "w-8 h-8 flex items-center justify-center bg-slate-900 rounded-full font-mono font-bold text-blue-400 text-sm border border-slate-700" }, p.number),
                                    React.createElement('span', { className: "font-bold text-slate-200" }, p.name)
                                ),
                                React.createElement('button', { type: "button", onClick: () => handleDeletePlayer(p.id), className: "text-slate-500 hover:text-red-500 p-2" }, React.createElement(Trash2, { size: 16 }))
                            ))
                        )
                    )
                )
            );
        };

        // 4.2. GESTOR DE COMPETI√á√ïES
        const CompsManager = ({ db }) => {
            const [isNewCompOpen, setIsNewCompOpen] = useState(false);
            const [newComp, setNewComp] = useState({ name: '', season: '2023/24' });

            return React.createElement('div', { className: "space-y-6 animate-in fade-in" },
                React.createElement('div', { className: "flex justify-end" }, 
                    React.createElement(Button, { icon: Plus, onClick: () => setIsNewCompOpen(true) }, "Nova Competi√ß√£o")
                ),
                React.createElement('div', { className: "grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4" },
                    db.data.comps.map(c => React.createElement(Card, { key: c.id, title: c.name, icon: Trophy },
                        React.createElement('p', { className: "text-sm text-slate-400 font-bold bg-slate-800 inline-block px-3 py-1 rounded border border-slate-700" }, c.season),
                        React.createElement('div', { className: "mt-4 flex justify-end" },
                             React.createElement(Button, { size: "sm", variant: "ghost", icon: Trash2, onClick: () => { if(confirm("Apagar?")) db.deleteComp(c.id) } })
                        )
                    ))
                ),
                React.createElement(Modal, { isOpen: isNewCompOpen, onClose: () => setIsNewCompOpen(false), title: "Nova Competi√ß√£o" },
                    React.createElement('div', { className: "p-6 space-y-4" },
                        React.createElement('input', { placeholder: "Nome do Campeonato (ex: 1¬™ Divis√£o)", className: "w-full bg-slate-900 border border-slate-700 p-3 rounded-lg text-slate-200 outline-none", value: newComp.name, onChange: e => setNewComp({...newComp, name: e.target.value}) }),
                        React.createElement('input', { placeholder: "√âpoca (ex: 2023/24)", className: "w-full bg-slate-900 border border-slate-700 p-3 rounded-lg text-slate-200 outline-none", value: newComp.season, onChange: e => setNewComp({...newComp, season: e.target.value}) }),
                        React.createElement(Button, { className: "w-full", variant: "success", onClick: () => { 
                            if(newComp.name) { 
                                db.addComp({id: Date.now().toString(), ...newComp}); 
                                setIsNewCompOpen(false); 
                                setNewComp({name:'', season:'2023/24'}); 
                            } 
                        } }, "Criar Competi√ß√£o")
                    )
                )
            );
        };

        // 4.3. DASHBOARD PRINCIPAL
        const DashboardView = ({ db, onOpenGame }) => {
            const [activeTab, setActiveTab] = useState('games');
            const [isNewGameOpen, setIsNewGameOpen] = useState(false);
            const [newGame, setNewGame] = useState({ compId: '', teamAId: '', teamBId: '', date: new Date().toISOString().split('T')[0] });

            const sortedGames = useMemo(() => [...db.data.games].sort((a,b) => new Date(b.date || 0) - new Date(a.date || 0)), [db.data.games]);

            const handleCreateGame = () => {
                if (!newGame.compId || !newGame.teamAId || !newGame.teamBId) return alert("Preenche todos os campos!");
                if (newGame.teamAId === newGame.teamBId) return alert("As equipas devem ser diferentes!");

                const comp = db.data.comps.find(c => c.id === newGame.compId);
                const tA = db.data.teams.find(t => t.id === newGame.teamAId);
                const tB = db.data.teams.find(t => t.id === newGame.teamBId);
                
                if (!comp || !tA || !tB) return alert("Erro: Competi√ß√£o ou equipa n√£o encontrada.");
                
                const gameObj = {
                    id: Date.now().toString(),
                    compId: newGame.compId,
                    compName: comp.name,
                    season: comp.season,
                    date: newGame.date,
                    teamA: { id: tA.id, name: tA.name, logo: tA.logo, players: tA.players || [] },
                    teamB: { id: tB.id, name: tB.name, logo: tB.logo, players: tB.players || [] },
                    clips: []
                };
                
                db.addGame(gameObj);
                setIsNewGameOpen(false);
                onOpenGame(gameObj.id);
            };

            const exportAllData = () => {
                const blob = new Blob([JSON.stringify(db.data, null, 2)], { type: 'application/json' });
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = `ATA_Backup_${new Date().toISOString().split('T')[0]}.json`;
                a.click();
            };

            const handleImportData = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const data = JSON.parse(event.target.result);
                        if (data.teams && data.comps && data.games) {
                            db.importDB(data);
                            alert("Base de dados importada com sucesso!");
                        } else alert("Ficheiro inv√°lido.");
                    } catch (err) { alert("Erro ao ler ficheiro."); }
                    e.target.value = null;
                };
                reader.readAsText(file);
            };

            return React.createElement('div', { className: "flex flex-col h-screen" },
                React.createElement('header', { className: "h-20 glass flex items-center justify-between px-8 shrink-0 z-10 shadow-lg" },
                    React.createElement('div', { className: "flex items-center gap-4" },
                        React.createElement('div', { className: "w-10 h-10 bg-blue-600 rounded-xl flex items-center justify-center shadow-lg shadow-blue-900/40 border border-blue-400" }, React.createElement(Activity, { className: "text-white" })),
                        React.createElement('div', null, 
                            React.createElement('h1', { className: "text-xl font-extrabold tracking-tight" }, "AT ANALYZER ", React.createElement('span', { className: "text-blue-500" }, "PRO")),
                            React.createElement('p', { className: "text-[10px] text-slate-400 font-bold uppercase tracking-widest" }, "Sistema Blindado v4.0")
                        )
                    ),
                    React.createElement('div', { className: "flex items-center gap-3" },
                        React.createElement('input', { type: "file", id: "db-upload", className: "hidden", accept: ".json", onChange: handleImportData }),
                        React.createElement(Button, { variant: "secondary", size: "sm", icon: Upload, onClick: () => document.getElementById('db-upload').click() }, "Importar DB"),
                        React.createElement(Button, { variant: "secondary", size: "sm", icon: Download, onClick: exportAllData }, "Backup DB"),
                        React.createElement(Button, { variant: "primary", size: "sm", icon: Plus, onClick: () => {
                            if (db.data.comps.length === 0 || db.data.teams.length < 2) return alert("Cria pelo menos 1 Competi√ß√£o e 2 Equipas primeiro.");
                            setIsNewGameOpen(true);
                        } }, "Novo Jogo")
                    )
                ),

                React.createElement('main', { className: "flex-1 overflow-y-auto p-8" },
                    React.createElement('div', { className: "max-w-6xl mx-auto" },
                        React.createElement('div', { className: "flex gap-8 border-b border-slate-800 mb-8" },
                            ['games', 'teams', 'comps'].map(tab => React.createElement('button', {
                                key: tab, type: "button", onClick: () => setActiveTab(tab),
                                className: `pb-4 text-sm font-bold transition-all border-b-2 ${activeTab === tab ? 'text-blue-500 border-blue-500' : 'text-slate-500 border-transparent hover:text-slate-300'}`
                            }, tab === 'games' ? 'Meus Jogos' : tab === 'teams' ? 'Equipas & Plant√©is' : 'Competi√ß√µes'))
                        ),

                        activeTab === 'games' && (
                            sortedGames.length === 0 ? React.createElement('div', { className: "flex flex-col items-center justify-center py-20 bg-slate-900/30 rounded-3xl border border-dashed border-slate-800" },
                                React.createElement(Film, { size: 48, className: "text-slate-700 mb-4" }),
                                React.createElement('p', { className: "text-slate-500 font-medium" }, "Nenhum jogo registado. Come√ßa agora!")
                            ) : React.createElement('div', { className: "grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 animate-in fade-in" },
                                sortedGames.map(game => React.createElement(Card, {
                                    key: game.id, className: "group hover:border-blue-500/50 hover:shadow-blue-900/10 transition-all cursor-pointer",
                                    extra: React.createElement('button', { type: "button", onClick: (e) => { e.stopPropagation(); if(confirm("Apagar Jogo?")) db.deleteGame(game.id) }, className: "text-slate-600 hover:text-red-500 p-1" }, React.createElement(Trash2, { size: 16 }))
                                }, 
                                    React.createElement('div', { onClick: () => onOpenGame(game.id) },
                                        React.createElement('div', { className: "flex justify-between items-start mb-4" },
                                            React.createElement('span', { className: "text-[10px] font-bold bg-slate-800 text-slate-400 px-2 py-1 rounded" }, game.season),
                                            React.createElement('span', { className: "text-[10px] text-slate-500 flex items-center gap-1 font-mono" }, React.createElement(Calendar, { size: 10 }), game.date)
                                        ),
                                        React.createElement('div', { className: "flex items-center gap-4 mb-4" },
                                            React.createElement('div', { className: "flex-1 text-center" }, 
                                                React.createElement('div', { className: "w-12 h-12 bg-slate-800 rounded-lg mx-auto mb-2 flex items-center justify-center border border-slate-700 overflow-hidden" }, game.teamA?.logo ? React.createElement('img', { src: game.teamA.logo, className: "w-full h-full object-contain p-1" }) : React.createElement(Shield, { size: 24, className: "text-slate-600" })),
                                                React.createElement('p', { className: "text-xs font-bold truncate text-slate-200" }, game.teamA?.name)
                                            ),
                                            React.createElement('div', { className: "text-xs font-black text-slate-600 bg-slate-900 px-2 py-1 rounded border border-slate-800" }, "VS"),
                                            React.createElement('div', { className: "flex-1 text-center" }, 
                                                React.createElement('div', { className: "w-12 h-12 bg-slate-800 rounded-lg mx-auto mb-2 flex items-center justify-center border border-slate-700 overflow-hidden" }, game.teamB?.logo ? React.createElement('img', { src: game.teamB.logo, className: "w-full h-full object-contain p-1" }) : React.createElement(Shield, { size: 24, className: "text-slate-600" })),
                                                React.createElement('p', { className: "text-xs font-bold truncate text-slate-200" }, game.teamB?.name)
                                            )
                                        ),
                                        React.createElement('div', { className: "pt-4 border-t border-slate-800 flex justify-between items-center" },
                                            React.createElement('div', { className: "flex items-center gap-1 text-[10px] text-slate-500 font-bold" }, React.createElement(Trophy, { size: 12 }), game.compName),
                                            React.createElement('div', { className: "flex items-center gap-1 text-[10px] text-blue-500 font-bold bg-blue-500/10 px-2 py-1 rounded" }, React.createElement(Scissors, { size: 12 }), `${game.clips?.length || 0} Cortes`)
                                        )
                                    )
                                ))
                            )
                        ),

                        activeTab === 'teams' && React.createElement(TeamsManager, { db }),
                        activeTab === 'comps' && React.createElement(CompsManager, { db })
                    )
                ),

                React.createElement(Modal, { isOpen: isNewGameOpen, onClose: () => setIsNewGameOpen(false), title: "Criar Novo Jogo" }, 
                    React.createElement('div', { className: "p-6 space-y-6" },
                        React.createElement('div', null, 
                            React.createElement('label', { className: "block text-xs font-bold text-slate-400 uppercase mb-2" }, "Competi√ß√£o"),
                            React.createElement('select', { className: "w-full bg-slate-900 border border-slate-700 rounded-xl p-3 outline-none focus:border-blue-500 text-slate-200", value: newGame.compId, onChange: e => setNewGame({...newGame, compId: e.target.value}) }, 
                                React.createElement('option', { value: "" }, "Selecionar Competi√ß√£o..."),
                                db.data.comps.map(c => React.createElement('option', { key: c.id, value: c.id }, `${c.name} (${c.season})`))
                            )
                        ),
                        React.createElement('div', { className: "grid grid-cols-2 gap-4 bg-slate-900 p-4 rounded-xl border border-slate-800" },
                            React.createElement('div', null, 
                                React.createElement('label', { className: "block text-xs font-bold text-blue-500 uppercase mb-2" }, "Equipa Casa (A)"),
                                React.createElement('select', { className: "w-full bg-slate-950 border border-slate-700 rounded-lg p-3 outline-none focus:border-blue-500 text-slate-200", value: newGame.teamAId, onChange: e => setNewGame({...newGame, teamAId: e.target.value}) }, 
                                    React.createElement('option', { value: "" }, "Selecionar Equipa..."),
                                    db.data.teams.map(t => React.createElement('option', { key: t.id, value: t.id }, t.name))
                                )
                            ),
                            React.createElement('div', null, 
                                React.createElement('label', { className: "block text-xs font-bold text-red-500 uppercase mb-2" }, "Equipa Fora (B)"),
                                React.createElement('select', { className: "w-full bg-slate-950 border border-slate-700 rounded-lg p-3 outline-none focus:border-red-500 text-slate-200", value: newGame.teamBId, onChange: e => setNewGame({...newGame, teamBId: e.target.value}) }, 
                                    React.createElement('option', { value: "" }, "Selecionar Equipa..."),
                                    db.data.teams.map(t => React.createElement('option', { key: t.id, value: t.id }, t.name))
                                )
                            )
                        ),
                        React.createElement('div', null, 
                            React.createElement('label', { className: "block text-xs font-bold text-slate-400 uppercase mb-2" }, "Data do Jogo"),
                            React.createElement('input', { type: "date", className: "w-full bg-slate-900 border border-slate-700 rounded-xl p-3 outline-none focus:border-blue-500 text-slate-200 font-mono", value: newGame.date, onChange: e => setNewGame({...newGame, date: e.target.value}) })
                        ),
                        React.createElement('div', { className: "pt-4 border-t border-slate-800 flex justify-end gap-3" },
                            React.createElement(Button, { variant: "ghost", onClick: () => setIsNewGameOpen(false) }, "Cancelar"),
                            React.createElement(Button, { variant: "success", icon: PlaySquare, onClick: handleCreateGame }, "Gerar e Analisar")
                        )
                    )
                )
            );
        };

        // =========================================================================
        // üé¨ M√ìDULO 5: ANALYZER VIEW (O V√çDEO E AS CLASSIFICA√á√ïES)
        // =========================================================================
        const AnalyzerView = ({ db, gameId, onReturn }) => {
            const game = useMemo(() => db.data.games.find(g => g.id === gameId), [db.data.games, gameId]);
            
            const [videoSrc, setVideoSrc] = useState(null);
            const [isPlaying, setIsPlaying] = useState(false);
            const [currentTime, setCurrentTime] = useState(0);
            const [duration, setDuration] = useState(0);
            
            const [inPoint, setInPoint] = useState(null);
            const [isModalOpen, setIsModalOpen] = useState(false);
            
            const [activeTeam, setActiveTeam] = useState('A'); 
            const [currentTags, setCurrentTags] = useState([]);
            const [selectedPlayerIds, setSelectedPlayerIds] = useState([]);
            
            const videoRef = useRef(null);

            useEffect(() => { return () => { if (videoSrc) URL.revokeObjectURL(videoSrc); }; }, [videoSrc]);

            const togglePlay = () => {
                if (!videoRef.current) return;
                if (videoRef.current.paused) {
                    videoRef.current.play().catch(e => console.error(e));
                    setIsPlaying(true);
                } else {
                    videoRef.current.pause();
                    setIsPlaying(false);
                }
            };

            const handleSaveClip = () => {
                if (!videoRef.current) return;
                const outPoint = videoRef.current.currentTime;
                const finalInPoint = inPoint !== null ? inPoint : Math.max(0, outPoint - 6);

                const newClip = {
                    id: Date.now().toString(),
                    start: finalInPoint,
                    end: outPoint,
                    team: activeTeam,
                    tags: currentTags,
                    playerIds: selectedPlayerIds
                };

                const updatedGame = { ...game, clips: [...(game.clips || []), newClip] };
                db.updateGame(updatedGame);
                
                setIsModalOpen(false);
                setInPoint(null);
                setCurrentTags([]);
                setSelectedPlayerIds([]);
                
                videoRef.current.play().catch(e => console.log(e));
                setIsPlaying(true);
            };

            const handleDeleteClip = (clipId) => {
                const updatedGame = { ...game, clips: game.clips.filter(c => c.id !== clipId) };
                db.updateGame(updatedGame);
            };

            if (!game) return React.createElement('div', { className: "p-10 text-center text-red-500" }, "Erro: Jogo n√£o encontrado.");

            const activePlayers = activeTeam === 'A' ? (game.teamA?.players || []) : (game.teamB?.players || []);

            return React.createElement('div', { className: "flex flex-col h-screen overflow-hidden animate-in fade-in" },
                React.createElement('header', { className: "h-16 glass flex items-center justify-between px-6 shrink-0 z-10 border-b border-slate-800" },
                    React.createElement('div', { className: "flex items-center gap-4" },
                        React.createElement('button', { type: "button", onClick: onReturn, className: "p-2 hover:bg-slate-800 rounded-lg text-slate-400 transition-colors bg-slate-900 border border-slate-700" }, React.createElement(ChevronLeft, { size: 20 })),
                        React.createElement('div', { className: "w-px h-6 bg-slate-700" }),
                        React.createElement('div', null,
                            React.createElement('h2', { className: "text-sm font-bold text-slate-200" }, `${game.teamA?.name} vs ${game.teamB?.name}`),
                            React.createElement('p', { className: "text-[10px] text-blue-400 uppercase font-bold" }, game.compName)
                        )
                    ),
                    React.createElement('div', { className: "flex items-center gap-2" },
                        React.createElement('input', { type: "file", id: "v-upload", className: "hidden", accept: "video/*", onChange: (e) => {
                            const file = e.target.files[0];
                            if(file) {
                                if(videoSrc) URL.revokeObjectURL(videoSrc);
                                setVideoSrc(URL.createObjectURL(file));
                                setIsPlaying(false);
                            }
                        }}),
                        React.createElement(Button, { variant: "primary", size: "sm", icon: FileVideo, onClick: () => document.getElementById('v-upload').click() }, videoSrc ? "Trocar V√≠deo" : "Carregar V√≠deo mp4")
                    )
                ),

                React.createElement('div', { className: "flex-1 flex overflow-hidden bg-slate-950" },
                    React.createElement('div', { className: "flex-1 flex flex-col p-4 gap-4" },
                        React.createElement('div', { className: "flex-1 bg-black rounded-2xl overflow-hidden relative shadow-2xl border border-slate-800 flex items-center justify-center" },
                            videoSrc ? React.createElement('video', {
                                ref: videoRef, src: videoSrc, className: "w-full h-full object-contain",
                                onClick: togglePlay, onTimeUpdate: () => setCurrentTime(videoRef.current?.currentTime || 0),
                                onLoadedMetadata: () => setDuration(videoRef.current?.duration || 0)
                            }) : React.createElement('div', { className: "flex flex-col items-center justify-center text-slate-700" }, 
                                React.createElement(Film, { size: 64, className: "mb-4 opacity-30" }),
                                React.createElement('p', { className: "font-bold text-slate-500 uppercase tracking-widest text-sm" }, "Aguardando Ficheiro")
                            ),
                            inPoint !== null && React.createElement('div', { className: "absolute top-6 left-6 flex items-center gap-2 bg-emerald-600/90 text-white px-4 py-2 rounded-lg text-xs font-black shadow-lg shadow-emerald-900/50 border border-emerald-400 recording-pulse" }, 
                                React.createElement('div', { className: "w-2 h-2 bg-white rounded-full" }), `GRAVANDO CORTE: ${formatTime(inPoint)}`
                            )
                        ),
                        React.createElement('div', { className: "h-auto glass rounded-2xl p-4 flex flex-col gap-3 border border-slate-800" },
                            React.createElement('input', { type: "range", className: "w-full focus:outline-none", min: 0, max: duration || 100, step: 0.1, value: currentTime, onChange: (e) => { const val = parseFloat(e.target.value); setCurrentTime(val); if(videoRef.current) videoRef.current.currentTime = val; } }),
                            React.createElement('div', { className: "flex items-center justify-between" },
                                React.createElement('div', { className: "flex items-center gap-4" },
                                    React.createElement('button', { type: "button", onClick: togglePlay, className: "w-12 h-12 bg-blue-600 hover:bg-blue-500 rounded-full flex items-center justify-center transition-transform active:scale-90 text-white shadow-lg shadow-blue-900/50" }, isPlaying ? React.createElement(Pause, { size: 24, fill: "currentColor" }) : React.createElement(Play, { size: 24, fill: "currentColor", className: "ml-1" })),
                                    React.createElement('div', { className: "bg-slate-900 px-3 py-1.5 rounded-lg border border-slate-700 text-sm font-mono" }, React.createElement('span', { className: "font-bold text-blue-400" }, formatTime(currentTime)), React.createElement('span', { className: "text-slate-600 mx-1" }, "/"), React.createElement('span', { className: "text-slate-400" }, formatTime(duration)))
                                ),
                                React.createElement('div', { className: "flex gap-3" },
                                    React.createElement('button', { type: "button", onClick: () => { if(!videoRef.current) return; setInPoint(videoRef.current.currentTime); }, className: `px-6 py-2 rounded-xl font-bold text-sm transition-all active:scale-95 shadow-lg ${inPoint !== null ? 'bg-emerald-600 text-white border border-emerald-500 shadow-emerald-900/50' : 'bg-slate-800 text-slate-300 border border-slate-700 hover:bg-slate-700'}` }, "Z: IN√çCIO DO LANCE"),
                                    React.createElement('button', { type: "button", onClick: () => { if(!videoRef.current) return; videoRef.current.pause(); setIsPlaying(false); setIsModalOpen(true); }, className: "px-6 py-2 bg-red-600 hover:bg-red-500 text-white rounded-xl font-bold text-sm shadow-lg shadow-red-900/50 border border-red-500 transition-all active:scale-95" }, "X: CORTAR & AVALIAR")
                                )
                            )
                        )
                    ),

                    React.createElement('aside', { className: "w-80 border-l border-slate-800 flex flex-col glass z-10" },
                        React.createElement('div', { className: "p-4 border-b border-slate-800 bg-slate-900" }, React.createElement('h3', { className: "text-xs font-black text-slate-500 uppercase tracking-widest flex items-center gap-2" }, React.createElement(ListVideo, { size: 14 }), "Hist√≥rico de Cortes")),
                        React.createElement('div', { className: "flex-1 overflow-y-auto p-4 space-y-3 bg-slate-950/50" },
                            (game.clips || []).length === 0 ? React.createElement('div', { className: "text-center mt-10 opacity-50" }, React.createElement(Scissors, { size: 32, className: "mx-auto mb-2 text-slate-600" }), React.createElement('p', { className: "text-xs text-slate-500 font-bold" }, "Sem cortes registados")) :
                            (game.clips || []).map(clip => React.createElement('div', { key: clip.id, onClick: () => { if(videoRef.current) { videoRef.current.currentTime = clip.start; videoRef.current.play(); setIsPlaying(true); } }, className: "bg-slate-900 border border-slate-800 rounded-xl p-3 hover:border-blue-500 transition-all cursor-pointer relative group overflow-hidden" },
                                React.createElement('div', { className: `absolute left-0 top-0 bottom-0 w-1.5 ${clip.team === 'A' ? 'bg-blue-500' : 'bg-red-500'}` }),
                                React.createElement('div', { className: "flex justify-between items-start mb-2 pl-2" },
                                    React.createElement('span', { className: "text-[11px] font-mono text-slate-300 font-bold bg-slate-950 px-2 py-0.5 rounded border border-slate-800" }, `${formatTime(clip.start)} - ${formatTime(clip.end)}`),
                                    React.createElement('button', { type: "button", onClick: (e) => { e.stopPropagation(); handleDeleteClip(clip.id); }, className: "text-slate-600 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-opacity bg-slate-950 p-1 rounded" }, React.createElement(Trash2, { size: 14 }))
                                ),
                                React.createElement('div', { className: "flex flex-wrap gap-1.5 pl-2" }, (clip.tags || []).slice(0, 4).map(t => React.createElement('span', { key: t, className: "text-[9px] bg-slate-800 px-1.5 py-0.5 rounded text-slate-300 font-bold" }, t)))
                            ))
                        )
                    )
                ),

                React.createElement(Modal, { isOpen: isModalOpen, onClose: () => { setIsModalOpen(false); if(videoRef.current) videoRef.current.play(); setIsPlaying(true); }, title: "Classificar Lance Furtado", maxWidth: "max-w-4xl" }, 
                    React.createElement('div', { className: "p-6 grid grid-cols-1 md:grid-cols-2 gap-8" },
                        React.createElement('div', { className: "space-y-6" },
                            React.createElement('div', null,
                                React.createElement('label', { className: "block text-[10px] font-black text-slate-500 uppercase mb-3 flex items-center gap-1" }, React.createElement(Shield, { size: 12 }), "Equipa Ativa no Lance"),
                                React.createElement('div', { className: "flex gap-2" },
                                    React.createElement('button', { type: "button", onClick: () => setActiveTeam('A'), className: `flex-1 py-3 rounded-xl border-2 font-bold transition-all ${activeTeam === 'A' ? 'bg-blue-900/30 border-blue-500 text-blue-400 shadow-inner' : 'bg-slate-900 border-slate-800 text-slate-500 hover:bg-slate-800'}` }, game.teamA?.name),
                                    React.createElement('button', { type: "button", onClick: () => setActiveTeam('B'), className: `flex-1 py-3 rounded-xl border-2 font-bold transition-all ${activeTeam === 'B' ? 'bg-red-900/30 border-red-500 text-red-400 shadow-inner' : 'bg-slate-900 border-slate-800 text-slate-500 hover:bg-slate-800'}` }, game.teamB?.name)
                                )
                            ),
                            React.createElement('div', null,
                                React.createElement('label', { className: "block text-[10px] font-black text-slate-500 uppercase mb-3 flex items-center gap-1" }, React.createElement(Users, { size: 12 }), "Jogadores Intervenientes"),
                                React.createElement('div', { className: "flex flex-wrap gap-2 max-h-32 overflow-y-auto p-2 bg-slate-900/50 rounded-xl border border-slate-800" },
                                    activePlayers.length === 0 ? React.createElement('span', { className: "text-xs text-slate-500 italic" }, "Sem jogadores.") :
                                    activePlayers.map(p => React.createElement(TagButton, { key: p.id, label: `${p.number} - ${p.name.split(' ')[0]}`, selected: selectedPlayerIds.includes(p.id), onClick: () => setSelectedPlayerIds(prev => prev.includes(p.id) ? prev.filter(id => id !== p.id) : [...prev, p.id]), color: activeTeam === 'A' ? 'blue' : 'red' }))
                                )
                            ),
                            React.createElement('div', null,
                                React.createElement('label', { className: "block text-[10px] font-black text-slate-500 uppercase mb-3 flex items-center gap-1" }, React.createElement(Tag, { size: 12 }), "Tags do Evento"),
                                React.createElement('div', { className: "space-y-4" },
                                    Object.entries(staticCategories).map(([cat, items]) => (
                                        React.createElement('div', { key: cat },
                                            React.createElement('span', { className: "text-[9px] text-slate-600 font-bold uppercase mb-1 block" }, cat),
                                            React.createElement('div', { className: "flex flex-wrap gap-1.5" }, items.map(item => React.createElement(TagButton, { key: item, label: item, selected: currentTags.includes(item), onClick: () => setCurrentTags(prev => prev.includes(item) ? prev.filter(t => t !== item) : [...prev, item]), color: cat === 'Resultado' ? 'green' : (cat === 'Turn Over' ? 'red' : 'blue') })))
                                        )
                                    ))
                                )
                            )
                        ),
                        React.createElement('div', { className: "space-y-6 flex flex-col" },
                            React.createElement('div', null,
                                React.createElement('label', { className: "block text-[10px] font-black text-slate-500 uppercase mb-3 flex items-center gap-1" }, React.createElement(MapPin, { size: 12 }), "Zona de Finaliza√ß√£o"),
                                React.createElement('div', { className: "grid grid-cols-4 gap-1.5 mb-3" },
                                    zones.map(z => React.createElement('button', { type: "button", key: z, onClick: () => setCurrentTags(prev => prev.includes(z) ? prev.filter(t => t !== z) : [...prev, z]), className: `py-2 rounded-lg text-[10px] font-bold border transition-colors ${currentTags.includes(z) ? 'bg-amber-500 border-amber-400 text-slate-900 shadow-lg shadow-amber-900/50' : 'bg-slate-900 border-slate-700 text-slate-400 hover:border-amber-500/50 hover:text-amber-400'}` }, z.replace("Zona ", "Z")))
                                )
                            ),
                            React.createElement('div', { className: "mt-auto pt-6" },
                                React.createElement(Button, { className: "w-full py-4 text-lg", variant: "primary", icon: Save, onClick: handleSaveClip }, "Guardar Corte na DB")
                            )
                        )
                    )
                )
            );
        };

        // =========================================================================
        // üöÄ M√ìDULO 6: ERROR BOUNDARY (O GUARDI√ÉO ANTI-CRASH)
        // =========================================================================
        class ErrorBoundary extends React.Component {
            constructor(props) { super(props); this.state = { hasError: false, error: null }; }
            static getDerivedStateFromError(error) { return { hasError: true, error }; }
            componentDidCatch(error, errorInfo) { console.error("Crash Protegido:", error, errorInfo); }
            render() {
                if (this.state.hasError) {
                    return React.createElement('div', { className: "p-10 flex flex-col items-center justify-center h-screen bg-slate-950 text-white" }, 
                        React.createElement(AlertTriangle, { size: 64, className: "text-red-500 mb-4 animate-pulse" }),
                        React.createElement('h1', { className: "text-2xl font-bold mb-2" }, "O React Protegeu a Aplica√ß√£o"),
                        React.createElement('p', { className: "text-slate-400 mb-6 text-center max-w-lg" }, "Ocorreu um problema ao renderizar a interface. Os teus dados est√£o a salvo."),
                        React.createElement('div', { className: "flex gap-4" },
                            React.createElement(Button, { onClick: () => window.location.reload() }, "Recarregar de Forma Segura"),
                            React.createElement(Button, { variant: "danger", onClick: () => { if(confirm("Isto apaga a Base de Dados permanentemente. Continuar?")) { localStorage.clear(); window.location.reload(); } } }, "Apagar DB e Fazer Reset")
                        )
                    );
                }
                return this.props.children;
            }
        }

        // =========================================================================
        // üöÄ M√ìDULO 7: ROOT APP (ROUTER PRINCIPAL)
        // =========================================================================
        function App() {
            const db = useGlobalDatabase();
            const [appView, setAppView] = useState('dashboard'); 
            const [activeGameId, setActiveGameId] = useState(null);

            if (appView === 'dashboard') {
                return React.createElement(DashboardView, {
                    db: db,
                    onOpenGame: (gameId) => {
                        setActiveGameId(gameId);
                        setAppView('analyzer');
                    }
                });
            }

            if (appView === 'analyzer') {
                return React.createElement(AnalyzerView, {
                    db: db,
                    gameId: activeGameId,
                    onReturn: () => setAppView('dashboard')
                });
            }

            return null;
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(React.createElement(ErrorBoundary, null, React.createElement(App)));
    </script>
</body>
</html>
