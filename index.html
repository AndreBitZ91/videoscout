<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ScoutMaster Pro</title>
    
    <!-- Tailwind CSS para o design -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Configuração de cores e estilos base -->
    <style>
        body { background-color: #020617; color: #f1f5f9; }
        /* Scrollbar personalizada */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #475569; }
        
        /* Animação de gravação */
        @keyframes pulse-red {
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }
        .recording-indicator {
            animation: pulse-red 2s infinite;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <!-- Importação do React e Lucide via CDN (Módulos ES) -->
    <script type="module">
        import React, { useState, useRef, useEffect, useCallback } from 'https://esm.sh/react@18.2.0';
        import ReactDOM from 'https://esm.sh/react-dom@18.2.0/client';
        import { 
            Play, Pause, Scissors, Download, Upload, 
            Trash2, Tag, ChevronRight, Save, X, RotateCcw, 
            FolderInput, Plus, MinusCircle, FileSpreadsheet,
            CheckSquare, Square, Film, Loader2, Clapperboard, MonitorPlay,
            Settings, UserPlus, Users, Shirt, Shield, Swords, FileJson, SaveAll, Database
        } from 'https://esm.sh/lucide-react@0.263.1';

        // --- Utilitários ---
        const formatTime = (seconds) => {
            if (!seconds && seconds !== 0) return "00:00";
            const m = Math.floor(seconds / 60);
            const s = Math.floor(seconds % 60);
            const ms = Math.floor((seconds % 1) * 10);
            return `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}.${ms}`;
        };

        const getCategoryColor = (categoryName) => {
            const lower = categoryName.toLowerCase();
            if (lower.includes('ataque') || lower.includes('ofensiv') || lower.includes('golo')) return 'green';
            if (lower.includes('defesa') || lower.includes('defensiv') || lower.includes('perda')) return 'red';
            if (lower.includes('disciplina') || lower.includes('cartão')) return 'yellow';
            return 'blue';
        };

        // --- Botão de Etiqueta ---
        const TagButton = React.memo(({ label, selected, onClick, color = "blue", onDelete }) => {
            const baseClasses = "px-4 py-2 rounded-lg font-semibold transition-all duration-200 border-2 relative group";
            const variants = {
                blue: selected 
                    ? "bg-blue-600 border-blue-600 text-white shadow-lg scale-105" 
                    : "bg-slate-800 border-slate-700 text-slate-300 hover:border-blue-500 hover:text-white",
                red: selected 
                    ? "bg-red-600 border-red-600 text-white shadow-lg scale-105" 
                    : "bg-slate-800 border-slate-700 text-slate-300 hover:border-red-500 hover:text-white",
                green: selected 
                    ? "bg-green-600 border-green-600 text-white shadow-lg scale-105" 
                    : "bg-slate-800 border-slate-700 text-slate-300 hover:border-green-500 hover:text-white",
                yellow: selected 
                    ? "bg-yellow-600 border-yellow-600 text-white shadow-lg scale-105" 
                    : "bg-slate-800 border-slate-700 text-slate-300 hover:border-yellow-500 hover:text-white",
                slate: selected
                    ? "bg-slate-500 border-slate-500 text-white shadow-lg scale-105"
                    : "bg-slate-900 border-slate-800 text-slate-400 hover:border-slate-600 hover:text-slate-200"
            };

            return React.createElement('div', { className: "relative inline-block" },
                React.createElement('button', { onClick: onClick, className: `${baseClasses} ${variants[color] || variants.blue}` }, label),
                onDelete && React.createElement('button', {
                    onClick: (e) => { e.stopPropagation(); onDelete(); },
                    className: "absolute -top-2 -right-2 bg-red-500 text-white rounded-full p-0.5 opacity-0 group-hover:opacity-100 transition-opacity shadow-sm",
                    title: "Remover etiqueta"
                }, React.createElement(MinusCircle, { size: 12 }))
            );
        });

        // --- Componente Principal ---
        function App() {
            // --- Estados ---
            const [videoSrc, setVideoSrc] = useState(null);
            const [videoFileName, setVideoFileName] = useState("");
            const [currentTime, setCurrentTime] = useState(0);
            const [duration, setDuration] = useState(0);
            const [isPlaying, setIsPlaying] = useState(false);
            
            // Estados de Corte
            const [inPoint, setInPoint] = useState(null);
            const [outPoint, setOutPoint] = useState(null);
            
            // Dados
            const [clips, setClips] = useState([]);
            const [selectedClips, setSelectedClips] = useState([]);
            
            // --- Base de Dados de Equipas ---
            const [teamDatabase, setTeamDatabase] = useState([]); // [{ id, name, players: [] }]
            
            // Info de Jogo Atual (Linkado à DB)
            const [matchInfo, setMatchInfo] = useState({
                teamAId: null, // ID da equipa na DB
                teamBId: null,
                teamA: "Equipa Casa",
                teamB: "Equipa Fora",
                playersA: [], 
                playersB: []
            });
            
            const [activeTeam, setActiveTeam] = useState('A'); 
            const [isConfigModalOpen, setIsConfigModalOpen] = useState(false);

            // Inputs temporários para adicionar jogador
            const [tempPlayerA, setTempPlayerA] = useState({ num: '', name: '' });
            const [tempPlayerB, setTempPlayerB] = useState({ num: '', name: '' });

            // Estados de Processamento
            const [isProcessing, setIsProcessing] = useState(false);
            const [processingStatus, setProcessingStatus] = useState("");
            const recorderRef = useRef(null);
            const chunksRef = useRef([]);
            const processingQueueRef = useRef([]);

            // Categorias e Tags
            const [tagCategories, setTagCategories] = useState({
                "Ataque": ["Golo", "Remate", "Canto a Favor", "Cruzamento"],
                "Defesa": ["Corte", "Desarme", "Canto Contra", "Defesa GR"],
                "Disciplina": ["Falta", "Cartão Amarelo", "Cartão Vermelho"]
            });

            // Modal de Tagging
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [currentTags, setCurrentTags] = useState([]);
            const [selectedPlayers, setSelectedPlayers] = useState([]); 
            const [comment, setComment] = useState("");

            // Tags Manuais
            const [customTags, setCustomTags] = useState([]); 
            const [newTagInput, setNewTagInput] = useState("");
            const [newTagColor, setNewTagColor] = useState("blue");

            // Refs
            const videoRef = useRef(null);
            const fileInputRef = useRef(null);
            const xmlInputRef = useRef(null);
            const csvInputRef = useRef(null);
            const customTagInputRef = useRef(null);
            const dbInputRef = useRef(null); // Ref para importar DB

            // Cleanup
            useEffect(() => {
                return () => { if (videoSrc) URL.revokeObjectURL(videoSrc); };
            }, [videoSrc]);

            // Foco
            useEffect(() => {
                if (isModalOpen && customTagInputRef.current) {
                    setTimeout(() => customTagInputRef.current.focus(), 100);
                }
            }, [isModalOpen]);

            // --- Gestão da Base de Dados de Equipas ---

            // Sincronizar Match Info com a Base de Dados
            const updateDatabaseFromMatch = useCallback((side, name, players, teamId) => {
                setTeamDatabase(prevDB => {
                    const newDB = [...prevDB];
                    
                    // Se temos um ID, atualizamos a equipa existente
                    if (teamId) {
                        const index = newDB.findIndex(t => t.id === teamId);
                        if (index !== -1) {
                            newDB[index] = { ...newDB[index], name, players };
                            return newDB;
                        }
                    }

                    // Se não temos ID, mas o nome já existe na DB, atualizamos essa
                    // (previne duplicados se o utilizador escrever um nome que já existe)
                    const existingIndex = newDB.findIndex(t => t.name.toLowerCase() === name.toLowerCase());
                    if (existingIndex !== -1) {
                         newDB[existingIndex] = { ...newDB[existingIndex], players }; // Atualiza plantel
                         // Nota: Deveríamos atualizar o ID no matchInfo também, mas isso requer useEffect
                         return newDB;
                    }

                    // Se é completamente nova, adicionamos
                    // Mas só se tiver um nome válido e diferente do default
                    if (name && name !== "Equipa Casa" && name !== "Equipa Fora") {
                        const newId = Date.now() + Math.random();
                        newDB.push({ id: newId, name, players });
                        
                        // Atualizar ID no matchInfo para ligar
                        setMatchInfo(prev => ({
                            ...prev,
                            [side === 'A' ? 'teamAId' : 'teamBId']: newId
                        }));
                    }
                    
                    return newDB;
                });
            }, []);

            // Função para selecionar equipa da lista
            const selectTeamFromDB = (side, teamId) => {
                if (teamId === "new") {
                    setMatchInfo(prev => ({
                        ...prev,
                        [side === 'A' ? 'teamAId' : 'teamBId']: null,
                        [side === 'A' ? 'teamA' : 'teamB']: side === 'A' ? "Nova Equipa A" : "Nova Equipa B",
                        [side === 'A' ? 'playersA' : 'playersB']: []
                    }));
                    return;
                }

                const team = teamDatabase.find(t => t.id.toString() === teamId.toString());
                if (team) {
                    setMatchInfo(prev => ({
                        ...prev,
                        [side === 'A' ? 'teamAId' : 'teamBId']: team.id,
                        [side === 'A' ? 'teamA' : 'teamB']: team.name,
                        [side === 'A' ? 'playersA' : 'playersB']: team.players || []
                    }));
                }
            };

            // Atualizar nome da equipa (e refletir na DB)
            const handleTeamNameChange = (side, newName) => {
                setMatchInfo(prev => {
                    const newState = { ...prev, [side === 'A' ? 'teamA' : 'teamB']: newName };
                    
                    // Se já estiver linkada a uma equipa da DB, atualiza a DB
                    const teamId = side === 'A' ? prev.teamAId : prev.teamBId;
                    if (teamId) {
                        setTeamDatabase(db => db.map(t => t.id === teamId ? { ...t, name: newName } : t));
                    }
                    
                    return newState;
                });
            };

            // Adicionar Jogador (e refletir na DB)
            const addPlayer = (teamSide) => {
                const input = teamSide === 'A' ? tempPlayerA : tempPlayerB;
                if (!input.num || !input.name) return;

                const newPlayer = { id: Date.now(), number: input.num, name: input.name };
                
                // Atualiza estado local do jogo
                setMatchInfo(prev => {
                    const key = teamSide === 'A' ? 'playersA' : 'playersB';
                    const newPlayers = [...prev[key], newPlayer].sort((a,b) => parseInt(a.number) - parseInt(b.number));
                    const newState = { ...prev, [key]: newPlayers };

                    // Atualiza DB Global
                    const teamId = teamSide === 'A' ? prev.teamAId : prev.teamBId;
                    const teamName = teamSide === 'A' ? prev.teamA : prev.teamB;
                    
                    // Se a equipa já existe na DB (por ID), atualiza
                    if (teamId) {
                        setTeamDatabase(db => db.map(t => t.id === teamId ? { ...t, players: newPlayers } : t));
                    } else {
                        // Se não existe (nova), cria na DB agora
                        const newId = Date.now();
                        const newTeamEntry = { id: newId, name: teamName, players: newPlayers };
                        setTeamDatabase(db => [...db, newTeamEntry]);
                        newState[teamSide === 'A' ? 'teamAId' : 'teamBId'] = newId;
                    }

                    return newState;
                });

                if (teamSide === 'A') setTempPlayerA({ num: '', name: '' });
                else setTempPlayerB({ num: '', name: '' });
            };

            const removePlayer = (teamSide, playerId) => {
                setMatchInfo(prev => {
                    const key = teamSide === 'A' ? 'playersA' : 'playersB';
                    const newPlayers = prev[key].filter(p => p.id !== playerId);
                    const newState = { ...prev, [key]: newPlayers };
                    
                    // Atualiza DB
                    const teamId = teamSide === 'A' ? prev.teamAId : prev.teamBId;
                    if (teamId) {
                        setTeamDatabase(db => db.map(t => t.id === teamId ? { ...t, players: newPlayers } : t));
                    }
                    return newState;
                });
            };

            // Exportar Base de Dados Completa
            const exportDatabase = () => {
                const data = {
                    version: "1.0",
                    teams: teamDatabase
                };
                const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(data, null, 2));
                const anchor = document.createElement('a');
                anchor.setAttribute("href", dataStr);
                anchor.setAttribute("download", `BASE_DADOS_EQUIPAS_${new Date().toISOString().slice(0,10)}.json`);
                document.body.appendChild(anchor);
                anchor.click();
                anchor.remove();
            };

            const loadDatabase = (event) => {
                const file = event.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = JSON.parse(e.target.result);
                        if (Array.isArray(data.teams)) {
                            // Merge inteligente: Mantém equipas existentes, adiciona novas se ID não existir
                            setTeamDatabase(prev => {
                                const newTeams = data.teams.filter(t => !prev.some(pt => pt.id === t.id));
                                return [...prev, ...newTeams]; 
                                // Nota: Para substituir completamente, seria apenas setTeamDatabase(data.teams);
                            });
                            alert(`${data.teams.length} equipas carregadas/atualizadas com sucesso!`);
                        } else {
                            alert("Formato de base de dados inválido.");
                        }
                    } catch (err) {
                        alert("Erro ao ler ficheiro.");
                    }
                };
                reader.readAsText(file);
            };

            // --- Lógica de Exportação VLC (M3U) ---
            const exportVLCPlaylist = () => {
                if (selectedClips.length === 0) return;
                const clipsToExport = clips.filter(c => selectedClips.includes(c.id)).sort((a, b) => a.start - b.start);
                let m3uContent = "#EXTM3U\n";
                clipsToExport.forEach((clip, index) => {
                    const teamName = clip.team === 'A' ? matchInfo.teamA : matchInfo.teamB;
                    const playerNames = clip.players ? clip.players.map(p => `#${p.number} ${p.name}`).join(', ') : '';
                    const title = `${index + 1}. [${teamName}] ${clip.tags.join(', ')} ${playerNames ? '[' + playerNames + ']' : ''} (${clip.comment || ''})`;
                    m3uContent += `#EXTINF:${Math.round(clip.duration)},${title}\n`;
                    m3uContent += `#EXTVLCOPT:start-time=${clip.start.toFixed(3)}\n`;
                    m3uContent += `#EXTVLCOPT:stop-time=${clip.end.toFixed(3)}\n`;
                    m3uContent += `${videoFileName}\n`;
                });
                const blob = new Blob([m3uContent], { type: 'audio/x-mpegurl' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `Highlights_VLC_${new Date().toISOString().slice(0,10)}.m3u`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                alert("Playlist VLC criada! Coloque o ficheiro na mesma pasta do vídeo original.");
            };

            // --- Lógica de Exportação de Vídeo ---
            const getSupportedMimeType = () => {
                const types = ['video/webm;codecs=vp9', 'video/webm;codecs=vp8', 'video/webm;codecs=h264', 'video/webm', 'video/mp4'];
                return types.find(type => MediaRecorder.isTypeSupported(type));
            };

            const processNextClip = useCallback(() => {
                if (processingQueueRef.current.length === 0) {
                    if (recorderRef.current && recorderRef.current.state !== 'inactive') {
                        recorderRef.current.stop();
                    }
                    return;
                }
                const currentClip = processingQueueRef.current[0];
                setProcessingStatus(`A gravar: ${formatTime(currentClip.start)} - ${formatTime(currentClip.end)}...`);
                if (videoRef.current) {
                    videoRef.current.currentTime = currentClip.start;
                    setTimeout(() => {
                        videoRef.current.play().then(() => {
                            if (recorderRef.current.state === 'paused') recorderRef.current.resume();
                        }).catch(e => console.error("Erro playback:", e));
                    }, 200);
                }
            }, []);

            useEffect(() => {
                if (!isProcessing || processingQueueRef.current.length === 0) return;
                const checkTime = () => {
                    if (!videoRef.current) return;
                    const currentClip = processingQueueRef.current[0];
                    if (videoRef.current.currentTime >= currentClip.end) {
                        videoRef.current.pause();
                        recorderRef.current.pause();
                        processingQueueRef.current.shift(); 
                        processNextClip();
                    }
                };
                const interval = setInterval(checkTime, 100);
                return () => clearInterval(interval);
            }, [isProcessing, processNextClip]);

            const startVideoExport = async () => {
                if (selectedClips.length === 0) return;
                const clipsToExport = clips.filter(c => selectedClips.includes(c.id)).sort((a, b) => a.start - b.start);
                if (clipsToExport.length === 0) return;
                const mimeType = getSupportedMimeType();
                if (!mimeType) { alert("Browser não suportado para gravação."); return; }
                if (!confirm(`Vai exportar ${clipsToExport.length} lances.\nNão mude de aba.`)) return;
                setIsProcessing(true);
                setProcessingStatus("A preparar gravação...");
                processingQueueRef.current = [...clipsToExport];
                chunksRef.current = [];
                try {
                    const stream = videoRef.current.captureStream(30); 
                    const recorder = new MediaRecorder(stream, { mimeType });
                    recorderRef.current = recorder;
                    recorder.ondataavailable = (e) => { if (e.data.size > 0) chunksRef.current.push(e.data); };
                    recorder.onstop = () => {
                        const blob = new Blob(chunksRef.current, { type: 'video/webm' });
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `Highlights_Browser_${new Date().getTime()}.webm`;
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        setIsProcessing(false);
                        setProcessingStatus("");
                        alert("Vídeo exportado com sucesso!");
                    };
                    recorder.start();
                    recorder.pause();
                    processNextClip();
                } catch (err) {
                    console.error(err);
                    alert(`Erro técnico: ${err.message}.`);
                    setIsProcessing(false);
                }
            };

            // --- Handlers ---
            const handleCSVUpload = (event) => {
                const file = event.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const text = e.target.result;
                        const lines = text.split(/\r?\n/).filter(line => line.trim() !== "");
                        if (lines.length < 2) { alert("CSV inválido."); return; }
                        const firstLine = lines[0];
                        const delimiter = (firstLine.match(/;/g) || []).length > (firstLine.match(/,/g) || []).length ? ';' : ',';
                        const headers = firstLine.split(delimiter).map(h => h.trim());
                        const newCategories = {};
                        headers.forEach(h => { if(h) newCategories[h] = []; });
                        for (let i = 1; i < lines.length; i++) {
                            const row = lines[i].split(delimiter);
                            headers.forEach((header, index) => {
                                if (row[index] && row[index].trim()) newCategories[header].push(row[index].trim());
                            });
                        }
                        setTagCategories(newCategories);
                        alert(`Etiquetas importadas!`);
                    } catch (err) { alert("Erro ao processar CSV."); }
                };
                reader.readAsText(file);
            };

            const handleFileUpload = (event) => {
                const file = event.target.files[0];
                if (file) {
                    const url = URL.createObjectURL(file);
                    setVideoSrc(url);
                    setVideoFileName(file.name);
                    setInPoint(null);
                    setOutPoint(null);
                    setSelectedClips([]);
                }
            };

            const handleXMLUpload = (event) => {
                const file = event.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const parser = new DOMParser();
                        const xmlDoc = parser.parseFromString(e.target.result, "text/xml");
                        const cortes = xmlDoc.getElementsByTagName("corte");
                        
                        // NOTA: Ao carregar XML, por segurança, não sobrescrevemos a DB de equipas
                        // Mas carregamos os nomes das equipas para o jogo atual
                        const meta = xmlDoc.getElementsByTagName("metadata")[0];
                        if (meta) {
                            const tA = meta.getElementsByTagName("teamA")[0]?.textContent;
                            const tB = meta.getElementsByTagName("teamB")[0]?.textContent;
                            if (tA && tB) {
                                setMatchInfo(prev => ({ ...prev, teamA: tA, teamB: tB }));
                            }
                        }

                        const loadedClips = Array.from(cortes).map(corte => {
                            const tagsText = corte.getElementsByTagName("etiquetas")[0]?.textContent || "";
                            
                            const jogadoresNode = corte.getElementsByTagName("jogadores")[0];
                            let players = [];
                            if (jogadoresNode) {
                                const jogadorNodes = jogadoresNode.getElementsByTagName("jogador");
                                players = Array.from(jogadorNodes).map(jn => ({
                                    number: jn.getAttribute("numero"),
                                    name: jn.textContent
                                }));
                            }

                            return {
                                id: parseFloat(corte.getAttribute("id")) || Date.now(),
                                start: parseFloat(corte.getElementsByTagName("inicio")[0]?.textContent || 0),
                                end: parseFloat(corte.getElementsByTagName("fim")[0]?.textContent || 0),
                                duration: parseFloat(corte.getElementsByTagName("duracao")[0]?.textContent || 0),
                                tags: tagsText ? tagsText.split(',').map(t => t.trim()) : [],
                                players: players,
                                team: corte.getElementsByTagName("equipa")[0]?.textContent === matchInfo.teamB ? 'B' : 'A',
                                comment: corte.getElementsByTagName("comentario")[0]?.textContent || ""
                            };
                        });
                        setClips(loadedClips);
                        alert(`${loadedClips.length} cortes carregados!`);
                    } catch (error) { alert("Erro no XML."); }
                };
                reader.readAsText(file);
            };

            const togglePlay = () => { if (videoRef.current) { if (isPlaying) videoRef.current.pause(); else videoRef.current.play(); setIsPlaying(!isPlaying); } };
            const handleTimeUpdate = () => { if (videoRef.current && !isProcessing) setCurrentTime(videoRef.current.currentTime); };
            const handleLoadedMetadata = () => { if (videoRef.current) setDuration(videoRef.current.duration); };

            const setIn = useCallback(() => { if (videoRef.current) setInPoint(videoRef.current.currentTime); }, []);
            const setOutAndOpenModal = useCallback(() => {
                if (!videoRef.current) return;
                const time = videoRef.current.currentTime;
                setOutPoint(time);
                videoRef.current.pause();
                setIsPlaying(false);
                if (inPoint === null) setInPoint(Math.max(0, time - 5));
                setIsModalOpen(true);
            }, [inPoint]);

            useEffect(() => {
                const handleKeyDown = (e) => {
                    if (isModalOpen || isProcessing || isConfigModalOpen) return;
                    if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
                    switch (e.key.toLowerCase()) {
                        case ' ': e.preventDefault(); togglePlay(); break;
                        case 'z': setIn(); break;
                        case 'x': setOutAndOpenModal(); break;
                        case 'a': setActiveTeam('A'); break;
                        case 's': setActiveTeam('B'); break;
                        case 'arrowleft': if(videoRef.current) videoRef.current.currentTime = Math.max(0, videoRef.current.currentTime - 3); break;
                        case 'arrowright': if(videoRef.current) videoRef.current.currentTime = Math.min(duration, videoRef.current.currentTime + 3); break;
                    }
                };
                window.addEventListener('keydown', handleKeyDown);
                return () => window.removeEventListener('keydown', handleKeyDown);
            }, [isPlaying, isModalOpen, setIn, setOutAndOpenModal, duration, isProcessing, isConfigModalOpen]);

            const toggleTag = useCallback((tag) => {
                setCurrentTags(prev => prev.includes(tag) ? prev.filter(t => t !== tag) : [...prev, tag]);
            }, []);

            const togglePlayerSelection = useCallback((player) => {
                setSelectedPlayers(prev => {
                    const exists = prev.find(p => p.number === player.number && p.name === player.name);
                    if (exists) return prev.filter(p => p.number !== player.number || p.name !== player.name);
                    return [...prev, player];
                });
            }, []);

            const addCustomTag = () => {
                if (!newTagInput.trim()) return;
                let exists = false;
                Object.values(tagCategories).forEach(tags => { if (tags.includes(newTagInput.trim())) exists = true; });
                if (exists || customTags.some(t => t.label === newTagInput.trim())) { alert("Já existe!"); return; }
                setCustomTags([...customTags, { label: newTagInput.trim(), color: newTagColor }]);
                setNewTagInput("");
            };
            const removeCustomTag = (label) => {
                setCustomTags(customTags.filter(t => t.label !== label));
                if (currentTags.includes(label)) setCurrentTags(currentTags.filter(t => t !== label));
            };

            const saveClip = () => {
                setClips([...clips, {
                    id: Date.now(),
                    start: inPoint,
                    end: outPoint,
                    duration: outPoint - inPoint,
                    tags: currentTags,
                    players: selectedPlayers,
                    team: activeTeam, 
                    comment: comment
                }]);
                closeModal();
            };

            const closeModal = () => {
                setIsModalOpen(false);
                setInPoint(null);
                setOutPoint(null);
                setCurrentTags([]);
                setSelectedPlayers([]);
                setComment("");
                setNewTagInput("");
            };

            const deleteClip = (id) => {
                setClips(clips.filter(c => c.id !== id));
                setSelectedClips(selectedClips.filter(sid => sid !== id));
            };
            const jumpToClip = (start) => {
                if (videoRef.current && !isProcessing) {
                    videoRef.current.currentTime = start;
                    videoRef.current.play();
                    setIsPlaying(true);
                }
            };
            const toggleClipSelection = (id) => setSelectedClips(prev => prev.includes(id) ? prev.filter(sid => sid !== id) : [...prev, id]);

            const exportXML = () => {
                let xmlContent = '<?xml version="1.0" encoding="UTF-8"?>\n<analise_desportiva>\n';
                xmlContent += `  <metadata>\n    <teamA>${matchInfo.teamA}</teamA>\n    <teamB>${matchInfo.teamB}</teamB>\n  </metadata>\n`;
                clips.forEach(clip => {
                    const teamName = clip.team === 'A' ? matchInfo.teamA : matchInfo.teamB;
                    xmlContent += `  <corte id="${clip.id}">\n    <inicio>${clip.start.toFixed(3)}</inicio>\n    <fim>${clip.end.toFixed(3)}</fim>\n    <duracao>${clip.duration.toFixed(3)}</duracao>\n    <equipa>${teamName}</equipa>\n    <etiquetas>${clip.tags.join(',')}</etiquetas>\n`;
                    if (clip.players && clip.players.length > 0) {
                        xmlContent += `    <jogadores>\n`;
                        clip.players.forEach(p => {
                            xmlContent += `      <jogador numero="${p.number}">${p.name}</jogador>\n`;
                        });
                        xmlContent += `    </jogadores>\n`;
                    }
                    xmlContent += `    <comentario>${clip.comment}</comentario>\n  </corte>\n`;
                });
                xmlContent += '</analise_desportiva>';
                const blob = new Blob([xmlContent], { type: 'text/xml' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `analise_jogo_${new Date().toISOString().slice(0,10)}.xml`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            };

            return React.createElement('div', { className: "flex flex-col h-screen bg-slate-950 text-slate-100 font-sans overflow-hidden" },
                // Overlays
                isProcessing && React.createElement('div', { className: "fixed inset-0 bg-black/90 z-[60] flex flex-col items-center justify-center p-8 text-center" },
                    React.createElement(Loader2, { size: 64, className: "text-red-500 animate-spin mb-4" }),
                    React.createElement('h2', { className: "text-2xl font-bold text-white mb-2" }, "A Exportar Vídeo..."),
                    React.createElement('p', { className: "text-slate-300 text-lg animate-pulse" }, processingStatus),
                    React.createElement('p', { className: "text-slate-500 text-sm mt-8 max-w-md" }, "Não feche nem minimize esta janela.")
                ),

                // Modal de Configuração de Jogo
                isConfigModalOpen && React.createElement('div', { className: "fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-4" },
                    React.createElement('div', { className: "bg-slate-900 w-full max-w-4xl rounded-2xl shadow-2xl border border-slate-700 overflow-hidden flex flex-col max-h-[90vh]" },
                        React.createElement('div', { className: "p-6 border-b border-slate-800 flex flex-col gap-4 bg-slate-800/50" },
                            React.createElement('div', { className: "flex justify-between items-center" },
                                React.createElement('h3', { className: "text-xl font-bold text-white flex items-center gap-2" }, 
                                    React.createElement(Database, { size: 24, className: "text-purple-500" }), "Base de Dados de Equipas"
                                ),
                                React.createElement('button', { onClick: () => setIsConfigModalOpen(false), className: "p-2 hover:bg-slate-700 rounded-full" }, React.createElement(X, { size: 24 }))
                            ),
                            React.createElement('div', { className: "flex gap-2 items-center bg-slate-800 p-3 rounded-lg border border-slate-700" },
                                React.createElement('input', { type: "file", accept: ".json", onChange: loadDatabase, ref: dbInputRef, className: "hidden" }),
                                React.createElement('button', { 
                                    onClick: () => dbInputRef.current.click(),
                                    className: "flex items-center gap-2 px-4 py-2 bg-slate-700 hover:bg-slate-600 rounded-md text-sm font-bold transition-colors" 
                                }, React.createElement(FolderInput, { size: 16 }), "Importar Base de Dados"),
                                React.createElement('button', { 
                                    onClick: exportDatabase,
                                    className: "flex items-center gap-2 px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded-md text-sm font-bold transition-colors" 
                                }, React.createElement(SaveAll, { size: 16 }), "Guardar Base de Dados"),
                                React.createElement('span', { className: "text-xs text-slate-400 ml-auto" }, `${teamDatabase.length} equipas na base de dados`)
                            )
                        ),
                        React.createElement('div', { className: "p-6 overflow-y-auto flex-1 grid grid-cols-1 md:grid-cols-2 gap-8" },
                            // Equipa A
                            React.createElement('div', { className: "space-y-4" },
                                React.createElement('div', { className: "bg-slate-800/50 p-4 rounded-xl border border-slate-700" },
                                    React.createElement('label', { className: "text-xs font-bold text-blue-400 uppercase tracking-wider mb-2 block" }, "Equipa Casa (A)"),
                                    // Dropdown para selecionar da DB
                                    React.createElement('select', { 
                                        className: "w-full bg-slate-900 border border-slate-700 rounded-md px-3 py-2 text-sm text-slate-300 mb-2 outline-none",
                                        onChange: (e) => selectTeamFromDB('A', e.target.value),
                                        value: matchInfo.teamAId || "new"
                                    },
                                        React.createElement('option', { value: "new" }, "--- Nova / Personalizada ---"),
                                        teamDatabase.map(t => React.createElement('option', { key: t.id, value: t.id }, t.name))
                                    ),
                                    React.createElement('input', { 
                                        value: matchInfo.teamA, 
                                        placeholder: "Nome da Equipa",
                                        onChange: (e) => handleTeamNameChange('A', e.target.value),
                                        className: "w-full bg-slate-950 border border-slate-700 rounded-md px-3 py-2 text-white font-bold focus:ring-2 focus:ring-blue-500 outline-none"
                                    })
                                ),
                                React.createElement('div', null,
                                    React.createElement('h4', { className: "text-sm font-bold text-slate-300 mb-2 flex items-center gap-2" }, React.createElement(Shirt, { size: 16 }), "Plantel"),
                                    React.createElement('div', { className: "flex gap-2 mb-3" },
                                        React.createElement('input', { 
                                            placeholder: "#", value: tempPlayerA.num, onChange: e => setTempPlayerA({...tempPlayerA, num: e.target.value}),
                                            className: "w-16 bg-slate-800 border border-slate-700 rounded px-2 py-1 text-sm outline-none" 
                                        }),
                                        React.createElement('input', { 
                                            placeholder: "Nome", value: tempPlayerA.name, onChange: e => setTempPlayerA({...tempPlayerA, name: e.target.value}),
                                            className: "flex-1 bg-slate-800 border border-slate-700 rounded px-2 py-1 text-sm outline-none" 
                                        }),
                                        React.createElement('button', { onClick: () => addPlayer('A'), className: "bg-blue-600 hover:bg-blue-700 text-white p-1 rounded" }, React.createElement(Plus, { size: 20 }))
                                    ),
                                    React.createElement('div', { className: "space-y-1 max-h-60 overflow-y-auto pr-2" },
                                        matchInfo.playersA.map(player => 
                                            React.createElement('div', { key: player.id, className: "flex justify-between items-center bg-slate-800 px-3 py-2 rounded text-sm" },
                                                React.createElement('span', null, React.createElement('span', { className: "font-mono font-bold text-blue-400 mr-2" }, player.number), player.name),
                                                React.createElement('button', { onClick: () => removePlayer('A', player.id), className: "text-slate-500 hover:text-red-500" }, React.createElement(Trash2, { size: 14 }))
                                            )
                                        )
                                    )
                                )
                            ),
                            // Equipa B
                            React.createElement('div', { className: "space-y-4" },
                                React.createElement('div', { className: "bg-slate-800/50 p-4 rounded-xl border border-slate-700" },
                                    React.createElement('label', { className: "text-xs font-bold text-red-400 uppercase tracking-wider mb-2 block" }, "Equipa Fora (B)"),
                                    // Dropdown para selecionar da DB
                                    React.createElement('select', { 
                                        className: "w-full bg-slate-900 border border-slate-700 rounded-md px-3 py-2 text-sm text-slate-300 mb-2 outline-none",
                                        onChange: (e) => selectTeamFromDB('B', e.target.value),
                                        value: matchInfo.teamBId || "new"
                                    },
                                        React.createElement('option', { value: "new" }, "--- Nova / Personalizada ---"),
                                        teamDatabase.map(t => React.createElement('option', { key: t.id, value: t.id }, t.name))
                                    ),
                                    React.createElement('input', { 
                                        value: matchInfo.teamB,
                                        placeholder: "Nome da Equipa", 
                                        onChange: (e) => handleTeamNameChange('B', e.target.value),
                                        className: "w-full bg-slate-950 border border-slate-700 rounded-md px-3 py-2 text-white font-bold focus:ring-2 focus:ring-red-500 outline-none"
                                    })
                                ),
                                React.createElement('div', null,
                                    React.createElement('h4', { className: "text-sm font-bold text-slate-300 mb-2 flex items-center gap-2" }, React.createElement(Shirt, { size: 16 }), "Plantel"),
                                    React.createElement('div', { className: "flex gap-2 mb-3" },
                                        React.createElement('input', { 
                                            placeholder: "#", value: tempPlayerB.num, onChange: e => setTempPlayerB({...tempPlayerB, num: e.target.value}),
                                            className: "w-16 bg-slate-800 border border-slate-700 rounded px-2 py-1 text-sm outline-none" 
                                        }),
                                        React.createElement('input', { 
                                            placeholder: "Nome", value: tempPlayerB.name, onChange: e => setTempPlayerB({...tempPlayerB, name: e.target.value}),
                                            className: "flex-1 bg-slate-800 border border-slate-700 rounded px-2 py-1 text-sm outline-none" 
                                        }),
                                        React.createElement('button', { onClick: () => addPlayer('B'), className: "bg-red-600 hover:bg-red-700 text-white p-1 rounded" }, React.createElement(Plus, { size: 20 }))
                                    ),
                                    React.createElement('div', { className: "space-y-1 max-h-60 overflow-y-auto pr-2" },
                                        matchInfo.playersB.map(player => 
                                            React.createElement('div', { key: player.id, className: "flex justify-between items-center bg-slate-800 px-3 py-2 rounded text-sm" },
                                                React.createElement('span', null, React.createElement('span', { className: "font-mono font-bold text-red-400 mr-2" }, player.number), player.name),
                                                React.createElement('button', { onClick: () => removePlayer('B', player.id), className: "text-slate-500 hover:text-red-500" }, React.createElement(Trash2, { size: 14 }))
                                            )
                                        )
                                    )
                                )
                            )
                        ),
                        React.createElement('div', { className: "p-4 bg-slate-800/50 border-t border-slate-800 flex justify-end" },
                            React.createElement('button', { onClick: () => setIsConfigModalOpen(false), className: "px-6 py-2 bg-blue-600 hover:bg-blue-500 text-white rounded-lg font-bold" }, "Concluir & Jogar")
                        )
                    )
                ),

                // Header Principal
                React.createElement('header', { className: "h-16 border-b border-slate-800 flex items-center justify-between px-6 bg-slate-900" },
                    React.createElement('div', { className: "flex items-center gap-2" },
                        React.createElement(Scissors, { className: "text-blue-500 w-6 h-6" }),
                        React.createElement('h1', { className: "text-xl font-bold tracking-tight" }, "ScoutMaster ", React.createElement('span', { className: "text-blue-500" }, "Pro"))
                    ),
                    React.createElement('div', { className: "flex items-center gap-2" },
                        // Botão de Configuração de Equipas
                        React.createElement('button', { 
                            onClick: () => setIsConfigModalOpen(true),
                            className: "flex items-center gap-2 px-3 py-1.5 bg-slate-800 hover:bg-slate-700 rounded-md text-sm font-medium text-blue-400 transition-colors border border-slate-700 mr-2" 
                        }, React.createElement(Settings, { size: 16 }), "Configurar Equipas"),

                        React.createElement('input', { type: "file", accept: "video/*", onChange: handleFileUpload, ref: fileInputRef, className: "hidden" }),
                        React.createElement('input', { type: "file", accept: ".xml", onChange: handleXMLUpload, ref: xmlInputRef, className: "hidden" }),
                        React.createElement('input', { type: "file", accept: ".csv", onChange: handleCSVUpload, ref: csvInputRef, className: "hidden" }),
                        React.createElement('div', { className: "flex bg-slate-800 rounded-lg p-1 gap-1" },
                            React.createElement('button', { onClick: () => fileInputRef.current.click(), className: "flex items-center gap-2 px-3 py-1.5 hover:bg-slate-700 rounded-md text-sm font-medium transition-colors text-slate-300 hover:text-white" }, React.createElement(Upload, { size: 16 }), " Vídeo"),
                            React.createElement('div', { className: "w-px bg-slate-700 my-1" }),
                            React.createElement('button', { onClick: () => xmlInputRef.current.click(), className: "flex items-center gap-2 px-3 py-1.5 hover:bg-slate-700 rounded-md text-sm font-medium transition-colors text-slate-300 hover:text-white" }, React.createElement(FolderInput, { size: 16 }), " XML"),
                            React.createElement('div', { className: "w-px bg-slate-700 my-1" }),
                            React.createElement('button', { onClick: () => csvInputRef.current.click(), className: "flex items-center gap-2 px-3 py-1.5 hover:bg-slate-700 rounded-md text-sm font-medium transition-colors text-slate-300 hover:text-white" }, React.createElement(FileSpreadsheet, { size: 16 }), " CSV")
                        ),
                        React.createElement('div', { className: "h-6 w-px bg-slate-800 mx-2" }),
                        React.createElement('button', { onClick: exportXML, disabled: clips.length === 0, className: `flex items-center gap-2 px-4 py-2 rounded-md text-sm font-medium transition-colors shadow-lg ${clips.length === 0 ? 'bg-slate-800 text-slate-500 cursor-not-allowed' : 'bg-blue-600 hover:bg-blue-700 text-white'}` }, React.createElement(Download, { size: 16 }), " XML")
                    )
                ),
                // Main
                React.createElement('div', { className: "flex flex-1 overflow-hidden" },
                    // Left Video
                    React.createElement('div', { className: "flex-1 flex flex-col p-4 gap-4 relative" },
                        React.createElement('div', { className: "flex-1 bg-black rounded-xl overflow-hidden shadow-2xl relative flex items-center justify-center border border-slate-800 group" },
                            videoSrc ? React.createElement('video', {
                                ref: videoRef, src: videoSrc, 
                                className: "w-full h-full object-contain",
                                crossOrigin: "anonymous", 
                                onClick: togglePlay, onTimeUpdate: handleTimeUpdate, onLoadedMetadata: handleLoadedMetadata
                            }) : React.createElement('div', { className: "text-center text-slate-500" },
                                React.createElement(Upload, { className: "w-16 h-16 mx-auto mb-4 opacity-50" }),
                                React.createElement('p', null, "Carregue um vídeo para começar"),
                                React.createElement('p', { className: "text-sm mt-2 opacity-60" }, "Suporta MP4, WebM, MOV")
                            ),
                            inPoint !== null && React.createElement('div', { className: "absolute top-4 left-4 bg-green-500/90 text-white px-3 py-1 rounded-md text-xs font-bold backdrop-blur-sm animate-pulse" }, `IN: ${formatTime(inPoint)}`)
                        ),
                        React.createElement('div', { className: "h-24 bg-slate-900 rounded-xl border border-slate-800 p-4 flex flex-col gap-2" },
                            React.createElement('input', {
                                type: "range", min: "0", max: duration || 100, value: currentTime,
                                onChange: (e) => { const t = parseFloat(e.target.value); setCurrentTime(t); if(videoRef.current) videoRef.current.currentTime = t; },
                                className: "w-full h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer accent-blue-500"
                            }),
                            React.createElement('div', { className: "flex items-center justify-between mt-1" },
                                React.createElement('div', { className: "flex items-center gap-4" },
                                    React.createElement('button', { onClick: togglePlay, className: "p-2 bg-slate-800 hover:bg-slate-700 rounded-full" }, isPlaying ? React.createElement(Pause, { size: 20 }) : React.createElement(Play, { size: 20 })),
                                    React.createElement('span', { className: "text-sm font-mono text-slate-300" }, `${formatTime(currentTime)} / ${formatTime(duration)}`),
                                    React.createElement('span', { className: "text-xs text-slate-500 ml-2 hidden lg:inline-block" }, "(Espaço: Play/Pause | ←/→ : -3s/+3s)")
                                ),
                                // Indicador de Equipa Ativa e Atalhos
                                React.createElement('div', { className: "flex items-center gap-2 bg-slate-800 rounded-lg p-1 mx-4" },
                                    React.createElement('button', { 
                                        onClick: () => setActiveTeam('A'),
                                        className: `px-3 py-1 text-xs font-bold rounded flex items-center gap-1 transition-all ${activeTeam === 'A' ? 'bg-blue-600 text-white shadow-md' : 'text-slate-400 hover:text-white'}`
                                    }, "[A] " + matchInfo.teamA),
                                    React.createElement('button', { 
                                        onClick: () => setActiveTeam('B'),
                                        className: `px-3 py-1 text-xs font-bold rounded flex items-center gap-1 transition-all ${activeTeam === 'B' ? 'bg-red-600 text-white shadow-md' : 'text-slate-400 hover:text-white'}`
                                    }, "[S] " + matchInfo.teamB)
                                ),

                                React.createElement('div', { className: "flex items-center gap-3" },
                                    React.createElement('div', { className: "flex flex-col items-center" },
                                        React.createElement('span', { className: "text-[10px] uppercase text-slate-500 font-bold mb-1" }, "Tecla 'Z'"),
                                        React.createElement('button', { onClick: setIn, className: `px-6 py-2 rounded-lg font-bold text-sm transition-all ${inPoint !== null ? 'bg-green-600 text-white shadow-lg' : 'bg-slate-800 text-slate-400'}` }, "MARCAR INÍCIO")
                                    ),
                                    React.createElement(ChevronRight, { className: "text-slate-600" }),
                                    React.createElement('div', { className: "flex flex-col items-center" },
                                        React.createElement('span', { className: "text-[10px] uppercase text-slate-500 font-bold mb-1" }, "Tecla 'X'"),
                                        React.createElement('button', { onClick: setOutAndOpenModal, className: "px-6 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg font-bold text-sm shadow-lg" }, "MARCAR FIM")
                                    )
                                )
                            )
                        )
                    ),
                    // Right Sidebar
                    React.createElement('div', { className: "w-80 bg-slate-900 border-l border-slate-800 flex flex-col" },
                        React.createElement('div', { className: "p-4 border-b border-slate-800 bg-slate-900 z-10 space-y-3" },
                            React.createElement('h2', { className: "font-bold flex items-center gap-2" }, React.createElement(Tag, { size: 16, className: "text-blue-500" }), `Lista de Cortes (${clips.length})`),
                            selectedClips.length > 0 && React.createElement('div', { className: "grid grid-cols-2 gap-2" },
                                React.createElement('button', { 
                                    onClick: startVideoExport,
                                    className: "flex items-center justify-center gap-1 bg-red-600 hover:bg-red-700 text-white py-2 rounded-lg text-xs font-bold transition-all recording-indicator" 
                                }, React.createElement(Film, { size: 14 }), `Gravar Ecrã`),
                                React.createElement('button', { 
                                    onClick: exportVLCPlaylist,
                                    className: "flex items-center justify-center gap-1 bg-orange-600 hover:bg-orange-700 text-white py-2 rounded-lg text-xs font-bold transition-all" 
                                }, React.createElement(Clapperboard, { size: 14 }), `Playlist VLC`)
                            )
                        ),
                        React.createElement('div', { className: "flex-1 overflow-y-auto p-3 space-y-3" },
                            clips.length === 0 ? React.createElement('div', { className: "text-center mt-10 p-6 opacity-40" },
                                React.createElement(Scissors, { size: 48, className: "mx-auto mb-4" }),
                                React.createElement('p', { className: "text-sm" }, "Ainda não há cortes."),
                                React.createElement('p', { className: "text-xs mt-1" }, "Use 'Z' para início e 'X' para fim.")
                            ) : clips.map(clip => React.createElement('div', { key: clip.id, className: `bg-slate-800 rounded-lg p-3 border transition-all ${selectedClips.includes(clip.id) ? 'border-blue-500 bg-slate-800/80' : 'border-slate-700 hover:border-slate-600'} group relative overflow-hidden` },
                                // Indicador lateral da equipa
                                React.createElement('div', { className: `absolute left-0 top-0 bottom-0 w-1 ${clip.team === 'A' ? 'bg-blue-500' : 'bg-red-500'}` }),
                                
                                React.createElement('div', { className: "flex justify-between items-start mb-2 pl-2" },
                                    React.createElement('div', { className: "flex items-center gap-2" },
                                        React.createElement('button', { onClick: () => toggleClipSelection(clip.id), className: "text-slate-400 hover:text-blue-400" }, 
                                            selectedClips.includes(clip.id) ? React.createElement(CheckSquare, { size: 18, className: "text-blue-500" }) : React.createElement(Square, { size: 18 })
                                        ),
                                        React.createElement('span', { className: "bg-slate-950 text-slate-400 text-xs font-mono px-2 py-1 rounded" }, `${formatTime(clip.start)} - ${formatTime(clip.end)}`)
                                    ),
                                    React.createElement('button', { onClick: () => deleteClip(clip.id), className: "text-slate-600 hover:text-red-500 opacity-0 group-hover:opacity-100" }, React.createElement(Trash2, { size: 14 }))
                                ),
                                React.createElement('div', { className: "flex flex-wrap gap-1 mb-2 ml-6" },
                                    clip.tags.map(tag => React.createElement('span', { key: tag, className: "text-[10px] uppercase font-bold px-2 py-0.5 rounded-full bg-slate-900 text-slate-300 border border-slate-700" }, tag))
                                ),
                                // Exibir Jogadores no clip
                                clip.players && clip.players.length > 0 && React.createElement('div', { className: "flex flex-wrap gap-1 mb-2 ml-6" },
                                    clip.players.map(p => React.createElement('span', { key: p.id, className: "text-[10px] font-bold px-2 py-0.5 rounded-full bg-slate-700 text-slate-300 flex items-center gap-1" }, 
                                        React.createElement(Shirt, { size: 10 }), `${p.number} ${p.name.split(' ')[0]}`
                                    ))
                                ),
                                clip.comment && React.createElement('p', { className: "text-xs text-slate-400 italic mb-2 border-l-2 border-slate-700 pl-2 ml-6" }, `"${clip.comment}"`),
                                React.createElement('button', { onClick: () => jumpToClip(clip.start), className: "w-full mt-1 flex items-center justify-center gap-1 text-xs bg-slate-700 hover:bg-slate-600 py-1.5 rounded text-slate-200" }, React.createElement(RotateCcw, { size: 12 }), " Rever Lance")
                            ))
                        )
                    )
                ),
                // Modal de Tagging
                isModalOpen && React.createElement('div', { className: "fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-4" },
                    React.createElement('div', { className: "bg-slate-900 w-full max-w-2xl rounded-2xl shadow-2xl border border-slate-700 overflow-hidden flex flex-col max-h-[90vh]" },
                        React.createElement('div', { className: "p-6 border-b border-slate-800 flex justify-between items-center bg-slate-800/50" },
                            React.createElement('div', null,
                                React.createElement('h3', { className: "text-xl font-bold text-white flex items-center gap-2" }, 
                                    "Classificar Lance",
                                    // Badge da equipa ativa no modal
                                    React.createElement('span', { 
                                        className: `text-xs px-2 py-1 rounded border ${activeTeam === 'A' ? 'bg-blue-900/50 border-blue-500 text-blue-300' : 'bg-red-900/50 border-red-500 text-red-300'}`
                                    }, activeTeam === 'A' ? matchInfo.teamA : matchInfo.teamB)
                                ),
                                React.createElement('p', { className: "text-sm text-slate-400 font-mono mt-1" }, "Intervalo: ", React.createElement('span', { className: "text-blue-400" }, formatTime(inPoint)), " a ", React.createElement('span', { className: "text-blue-400" }, formatTime(outPoint)))
                            ),
                            React.createElement('button', { onClick: closeModal, className: "p-2 hover:bg-slate-700 rounded-full" }, React.createElement(X, { size: 24 }))
                        ),
                        React.createElement('div', { className: "p-6 overflow-y-auto flex-1" },
                            React.createElement('div', { className: "space-y-6" },
                                
                                // Secção de Seleção de Jogadores
                                (matchInfo.playersA.length > 0 || matchInfo.playersB.length > 0) && React.createElement('div', { className: "bg-slate-800/30 p-4 rounded-xl border border-slate-700/50" },
                                    React.createElement('h4', { className: "text-xs font-bold text-slate-400 uppercase tracking-wider mb-3 flex items-center gap-2" }, 
                                        React.createElement(Users, { size: 14 }), "Jogadores Envolvidos"
                                    ),
                                    React.createElement('div', { className: "grid grid-cols-2 gap-4" },
                                        // Jogadores Equipa A
                                        matchInfo.playersA.length > 0 && React.createElement('div', { className: activeTeam !== 'A' ? 'opacity-50 grayscale' : '' },
                                            React.createElement('div', { className: "text-xs font-bold text-blue-400 mb-2" }, matchInfo.teamA),
                                            React.createElement('div', { className: "flex flex-wrap gap-2" },
                                                matchInfo.playersA.map(p => React.createElement(TagButton, {
                                                    key: p.id,
                                                    label: `${p.number} ${p.name.split(' ')[0]}`,
                                                    color: "slate",
                                                    selected: selectedPlayers.some(sp => sp.id === p.id),
                                                    onClick: () => togglePlayerSelection(p)
                                                }))
                                            )
                                        ),
                                        // Jogadores Equipa B
                                        matchInfo.playersB.length > 0 && React.createElement('div', { className: activeTeam !== 'B' ? 'opacity-50 grayscale' : '' },
                                            React.createElement('div', { className: "text-xs font-bold text-red-400 mb-2" }, matchInfo.teamB),
                                            React.createElement('div', { className: "flex flex-wrap gap-2" },
                                                matchInfo.playersB.map(p => React.createElement(TagButton, {
                                                    key: p.id,
                                                    label: `${p.number} ${p.name.split(' ')[0]}`,
                                                    color: "slate",
                                                    selected: selectedPlayers.some(sp => sp.id === p.id),
                                                    onClick: () => togglePlayerSelection(p)
                                                }))
                                            )
                                        )
                                    )
                                ),

                                React.createElement('hr', { className: "border-slate-800" }),

                                Object.entries(tagCategories).map(([category, tags]) => React.createElement('div', { key: category },
                                    React.createElement('h4', { className: "text-xs font-bold text-slate-500 uppercase tracking-wider mb-3" }, category),
                                    React.createElement('div', { className: "flex flex-wrap gap-3" },
                                        tags.map(tag => React.createElement(TagButton, {
                                            key: tag, label: tag, color: getCategoryColor(category),
                                            selected: currentTags.includes(tag), onClick: () => toggleTag(tag)
                                        }))
                                    )
                                )),
                                React.createElement('hr', { className: "border-slate-800 my-4" }),
                                React.createElement('div', { className: "bg-slate-800/50 p-4 rounded-lg border border-slate-700" },
                                    React.createElement('h4', { className: "text-xs font-bold text-slate-400 uppercase tracking-wider mb-2" }, "Etiqueta Extra"),
                                    React.createElement('div', { className: "flex gap-2" },
                                        React.createElement('input', {
                                            type: "text", ref: customTagInputRef, value: newTagInput,
                                            onChange: (e) => setNewTagInput(e.target.value), placeholder: "Criar nova...",
                                            className: "flex-1 bg-slate-950 border border-slate-700 rounded-md px-3 text-sm focus:ring-2 focus:ring-blue-500 outline-none"
                                        }),
                                        React.createElement('select', {
                                            value: newTagColor, onChange: (e) => setNewTagColor(e.target.value),
                                            className: "bg-slate-950 border border-slate-700 rounded-md px-2 text-sm text-slate-300 outline-none"
                                        },
                                            React.createElement('option', { value: "blue" }, "Geral"),
                                            React.createElement('option', { value: "green" }, "Verde"),
                                            React.createElement('option', { value: "red" }, "Vermelho"),
                                            React.createElement('option', { value: "yellow" }, "Amarelo")
                                        ),
                                        React.createElement('button', { onClick: addCustomTag, className: "bg-slate-700 hover:bg-slate-600 text-white px-3 py-2 rounded-md" }, React.createElement(Plus, { size: 18 }))
                                    )
                                ),
                                customTags.length > 0 && React.createElement('div', null,
                                    React.createElement('h4', { className: "text-xs font-bold text-yellow-500 uppercase tracking-wider mb-3 mt-2" }, "Personalizadas"),
                                    React.createElement('div', { className: "flex flex-wrap gap-3" },
                                        customTags.map((tag, idx) => React.createElement(TagButton, {
                                            key: `custom-${idx}`, label: tag.label, color: tag.color,
                                            selected: currentTags.includes(tag.label), onClick: () => toggleTag(tag.label),
                                            onDelete: () => removeCustomTag(tag.label)
                                        }))
                                    )
                                ),
                                React.createElement('div', null,
                                    React.createElement('h4', { className: "text-xs font-bold text-slate-500 uppercase tracking-wider mb-3" }, "Notas"),
                                    React.createElement('textarea', {
                                        placeholder: "Observações táticas...", value: comment,
                                        onChange: (e) => setComment(e.target.value),
                                        className: "w-full bg-slate-950 border border-slate-700 rounded-lg p-3 text-slate-200 focus:ring-2 focus:ring-blue-500 outline-none h-20 text-sm"
                                    })
                                )
                            )
                        ),
                        React.createElement('div', { className: "p-4 bg-slate-800/50 border-t border-slate-800 flex justify-end gap-3" },
                            React.createElement('button', { onClick: closeModal, className: "px-6 py-2 rounded-lg text-slate-300 hover:bg-slate-800 font-medium" }, "Cancelar"),
                            React.createElement('button', { onClick: saveClip, className: "px-8 py-2 bg-blue-600 hover:bg-blue-500 text-white rounded-lg font-bold shadow-lg flex items-center gap-2" }, React.createElement(Save, { size: 18 }), " Guardar Corte")
                        )
                    )
                )
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(React.createElement(App));
    </script>
</body>
</html>
